name: aws-guardduty
pipeline:
  - name: json_event
    external:
      name: json.parse-json
  - name: parsed_date
    external:
      name: date.parse
      properties:
        input_field: '{{json_event.message.updatedAt}}'
        output_field: datetime
  - name: parsed_finding
    external:
      name: grok.match
      properties:
        input_field: json_event.message.type
        output_field: finding
        pattern: '%{DATA:threat_purpose}:%{DATA:affected_resource_type}/%{DATA:threat_family_name}(.%{DATA:detection_mecanism})?(!%{DATA:artifact})?'
  - name: set_fields
  - name: set_finding_fields

stages:
  set_fields:
    actions:
      - set:
          '@timestamp': '{{parsed_date.datetime}}'
          event.action: '{{parsed_finding.finding.threat_purpose}}'
          event.kind: 'alert'
          event.severity: '{{json_event.message.severity}}'
          cloud.account.id: '{{json_event.message.accountId}}'
          cloud.region: '{{json_event.message.region}}'
          cloud.provider: '{{json_event.message.partition}}'
          agent.version: '{{json_event.message.schemaVersion}}'
          service.name: '{{json_event.message.service.service.name}}'
          user.name: '{{json_event.message.resource.accessKeyDetails.userName or json_event.message.resource.rdsDbUserDetails.user or json_event.message.resource.kubernetesDetails.kubernetesUserDetails.username}}' #to modify, does not work for all findings format
      - set:
          user.group.name: '{{json_event.message.resource.kubernetesDetails.kubernetesUserDetails.groups}}'
        filter: '{{json_event.message.resource.get("kubernetesDetails") != None}}'
      - set:
          source.ip: '{{json_event.message.service.action.networkConnectionAction.remoteIpDetails.ipAddressV4 or json_event.message.service.action.awsApiCallAction.remoteIpDetails.ipAddressV4 or json_event.message.service.action.kubernetesApiCallAction.remoteIpDetails.ipAddressV4}}'
      - set:
          destination.ip: '{{json_event.message.service.action.networkConnectionAction.localIpDetails.ipAddressV4}}'
        filter: '{{json_event.message.service.action.get("networkConnectionAction") != None}}'
      - set:
          threat.indicator.description: '{{json_event.message.description}}'
          threat.enrichments.indicator.first_seen: '{{json_event.message.service.eventFirstSeen}}'
          threat.enrichments.indicator.last_seen: '{{json_event.message.service.eventLastSeen}}'
          threat.enrichments.indicator.sightings: '{{json_event.message.service.count}}'
      - set:
          threat.evidence: '{{json_event.message.service.evidence.threatIntelligenceDetails}}'
        filter: '{{json_event.message.service.get("evidence") != None or "null"}}'

  set_finding_fields:
    actions:
      - set:
          aws.guardduty.finding.id: '{{json_event.message.id}}'
          aws.guardduty.finding.type: '{{json_event.message.type}}'
          aws.guardduty.finding.region: '{{json_event.message.region}}'
          aws.guardduty.finding.resource.type: '{{json_event.message.resource.resourceType}}'
          aws.guardduty.finding.resource.role: '{{json_event.message.service.resourceRole | lower }}'
      - set:
          aws.guardduty.finding.principal.id: '{{json_event.message.resource.accessKeyDetails.principalId}}'
        filter: '{{json_event.message.resource.get("accessKeyDetails") != None}}'
      - set:
          aws.guardduty.finding.instance: '{{json_event.message.resource.instanceDetails}}'
        filter: '{{json_event.message.resource.get("instanceDetails") != None}}'
      - set:
          aws.guardduty.finding.accesskey: '{{json_event.message.resource.accessKeyDetails}}'
        filter: '{{json_event.message.resource.get("accessKeyDetails") != None}}'         
      - set:
          container.id: '{{json_event.message.resource.containerDetails.id}}'
          container.name: '{{json_event.message.resource.containerDetails.name}}'
          container.image.name: '{{json_event.message.resource.containerDetails.image}}'
        filter: '{{json_event.message.resource.get("containerDetails") != None}}'
      - set:
          aws.guardduty.finding.rdsdb.instance: '{{json_event.message.resource.rdsDbInstanceDetails}}'
        filter: '{{json_event.message.resource.get("rdsDbInstanceDetails") != None}}'        
      - set:
          aws.guardduty.finding.rdsdb.user: '{{json_event.message.resource.rdsDbUserDetails}}'
        filter: '{{json_event.message.resource.get("rdsDbUserDetails") != None}}'
      - set:
          aws.guardduty.finding.eks.details: '{{json_event.message.resource.eksClusterDetails}}'
        filter: '{{json_event.message.resource.get("eksClusterDetails") != None}}'   
      - set:
          aws.guardduty.finding.eks.user_uid: '{{json_event.message.resource.kubernetesDetails.kubernetesUserDetails.uid}}'
        filter: '{{json_event.message.resource.get("kubernetesDetails") != None}}'    
      - set:
          aws.guardduty.finding.ecs: '{{json_event.message.resource.ecsClusterDetails}}'
        filter: '{{json_event.message.resource.get("ecsClusterDetails") != None}}' 
      - set:
          aws.guardduty.finding.s3bucket: '{{json_event.message.resource.s3BucketDetails}}'
        filter: '{{json_event.message.resource.get("s3BucketDetails") != None}}'
      - set:
          aws.guardduty.finding.volume.details: '{{json_event.message.resource.ebsVolumeDetails.scannedVolumeDetails}}'
        filter: '{{json_event.message.resource.get("ebsVolumeDetails") != None}}'
      - set:
          aws.guardduty.finding.service.action.type: '{{json_event.message.service.action.actionType}}'
          aws.guardduty.finding.service.resource.role: '{{json_event.message.service.resourceRole}}'
          aws.guardduty.finding.service.additional_info: '{{json_event.message.service.additionalInfo}}'
      - set:
          network.direction: '{{json_event.message.service.action.networkConnectionAction.connectionDirection|lower }}'
          source.geo.country_name: '{{json_event.message.service.action.networkConnectionAction.remoteIpDetails.country.countryName}}'
          source.geo.location: '{{json_event.message.service.action.networkConnectionAction.remoteIpDetails.geoLocation}}'
          source.geo.city_name: '{{json_event.message.service.action.networkConnectionAction.remoteIpDetails.city.cityName}}'
          network.transport:  '{{json_event.message.service.action.networkConnectionAction.protocol|lower }}'
          source.port: '{{json_event.message.service.action.networkConnectionAction.remotePortDetails.port}}'
          source.ip: '{{json_event.message.service.action.networkConnectionAction.remoteIpDetails.ipAddressV4}}'
          destination.port: '{{json_event.message.service.action.networkConnectionAction.localPortDetails.port}}'
          destination.ip: '{{json_event.message.service.action.networkConnectionAction.localIpDetails.ipAddressV4}}'
          aws.guardduty.finding.service.action.target.blocked: '{{json_event.message.service.action.networkConnectionAction.blocked}}'
        filter: '{{json_event.message.service.action.actionType == "NETWORK_CONNECTION"}}'
      - set:
          source.geo.country_name: '{{json_event.message.service.action.awsApiCallAction.remoteIpDetails.country.countryName}}'
          source.geo.location: '{{json_event.message.service.action.awsApiCallAction.remoteIpDetails.geoLocation}}'
          source.geo.city_name: '{{json_event.message.service.action.awsApiCallAction.remoteIpDetails.city.cityName}}'
          source.ip: '{{json_event.message.service.action.awsApiCallAction.remoteIpDetails.ipAddressV4}}'
          error.code: '{{json_event.message.service.action.awsApiCallAction.errorCode}}'
          service.name: '{{json_event.message.service.action.awsApiCallAction.serviceName}}'
        filter: '{{json_event.message.service.action.actionType == "AWS_API_CALL"}}'
      - set:
          source.geo.country_name: '{{json_event.message.service.action.kubernetesApiCallAction.remoteIpDetails.country.countryName}}'
          source.geo.location: '{{json_event.message.service.action.kubernetesApiCallAction.remoteIpDetails.geoLocation}}'
          source.geo.city_name: '{{json_event.message.service.action.kubernetesApiCallAction.remoteIpDetails.city.cityName}}'
          source.ip: '{{json_event.message.service.action.kubernetesApiCallAction.remoteIpDetails.ipAddressV4}}'        
        filter: '{{json_event.message.service.action.actionType == "KUBERNETES_API_CALL"}}'
      - set:
          aws.guardduty.finding.service.action.port_probe_details: '{{json_event.message.service.action.portProbeAction.portProbeDetails}}'
          aws.guardduty.finding.service.action.target.blocked: '{{json_event.message.service.action.portProbeAction.blocked}}'
        filter: '{{json_event.message.service.action.actionType == "PORT_PROBE"}}'
      - set:
          network.protocol: 'dns'
          destination.domain: '{{json_event.message.service.action.dnsRequestAction.domain}}'
          network.transport: '{{json_event.message.service.action.dnsRequestAction.protocol|lower }}'
          aws.guardduty.finding.service.action.target.blocked: '{{json_event.message.service.action.dnsRequestAction.blocked}}'
        filter: '{{json_event.message.service.action.actionType == "DNS_REQUEST"}}'
      - set:
          source.geo.country_name: '{{json_event.message.service.action.rdsLoginAttemptActionremoteIpDetails.country.countryName}}'
          source.geo.location: '{{json_event.message.service.action.rdsLoginAttemptActionremoteIpDetails.geoLocation}}'
          source.geo.city_name: '{{json_event.message.service.action.rdsLoginAttemptActionremoteIpDetails.city.cityName}}'
          source.ip: '{{json_event.message.service.action.rdsLoginAttemptAction.remoteIpDetails.ipAddressV4}}'
        filter: '{{json_event.message.service.action.actionType == "RDS_LOGIN_ATTEMPT"}}'
      - set:
          aws.guardduty.finding.volume.scan: '{{json_event.message.service.ebsVolumeScanDetails}}'
        filter: '{{json_event.message.service.featureName == "EbsVolumeScan"}}'
      - delete:
          - aws.guardduty.finding.service.resource
        filter: '{{json_event.message.service.get("action") != None}}'
        name: delete
      
